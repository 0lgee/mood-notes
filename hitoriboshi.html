<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„Å≤„Å®„Çä„Åº„Åóü™ê</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .lucide {
        display: inline-block;
        vertical-align: middle;
      }
      .aspect-square {
        aspect-ratio: 1 / 1;
      }
      .group:hover .group-hover\:block {
        display: block;
      }
      /* „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }

      /* Êòü„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.2;
          transform: scale(0.8);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.2);
        }
      }
      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle 4s ease-in-out infinite;
      }

      /* „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body>
    <div
      id="app"
      class="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-indigo-500/30"
    ></div>

    <script>
      // =================================================================
      // 1. „Ç∞„É≠„Éº„Éê„É´„Å™StateÂ§âÊï∞
      // =================================================================

      let categories = [
        { name: "Êó•Â∏∏", color: "#bf8a8a" },
        { name: "„Ç¢„Ç§„Éá„Ç¢", color: "#d4a373" },
        { name: "ÈñãÁô∫„É≠„Ç∞", color: "#669bbc" },
        { name: "Â§ú", color: "#8187dc" },
        { name: "Ë™≠Êõ∏", color: "#a3b18a" },
        { name: "Èü≥Ê•Ω", color: "#c08497" },
      ];

      // Êó•‰ªòÁîüÊàê„Éò„É´„Éë„Éº
      const createDate = (daysAgo, hour, minute) => {
        const d = new Date();
        d.setDate(d.getDate() - daysAgo);
        d.setHours(hour, minute, 0, 0);
        return d;
      };
      const fmtDate = (d) => d.toLocaleString("ja-JP");
      const isoDate = (d) => d.toISOString();

      let notes = [
        {
          id: createDate(0, 14, 30).getTime(),
          content:
            "ÂçàÂæå„ÅÆÊó•Â∑Æ„Åó„ÅåÁ™ì„Å´Â∑Æ„ÅóËæº„Çì„Åß„Åç„Åü„ÄÇÂ∞ë„Åó‰ºëÊÜ©„Åó„Å¶„ÄÅÁ©çË™≠„Åó„Å¶„ÅÑ„ÅüÊú¨„ÇíÂ∞ë„Åó„Å†„ÅëË™≠„ÇÄ„ÄÇ\nÈùô„Åã„Å™ÊôÇÈñì„ÅåÊµÅ„Çå„Å¶„ÅÑ„Çã„ÄÇ",
          categories: [
            { name: "Êó•Â∏∏", color: "#bf8a8a" },
            { name: "Ë™≠Êõ∏", color: "#a3b18a" },
          ],
          timestamp: isoDate(createDate(0, 14, 30)),
          dateStr: fmtDate(createDate(0, 14, 30)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(0, 12, 15).getTime(),
          content:
            "„ÅäÊòº„Åî„ÅØ„Çì„ÄÇËøë„Åè„ÅÆ„Ç´„Éï„Çß„Åß„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ„ÄÇ\nÈ†≠„Åå„É™„Éï„É¨„ÉÉ„Ç∑„É•„Åï„Çå„Åü„ÅÆ„Åß„ÄÅÂçàÂæå„ÅØÈõÜ‰∏≠„Åß„Åç„Åù„ÅÜ„ÄÇ",
          categories: [{ name: "Êó•Â∏∏", color: "#bf8a8a" }],
          timestamp: isoDate(createDate(0, 12, 15)),
          dateStr: fmtDate(createDate(0, 12, 15)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(0, 8, 45).getTime(),
          content:
            "„Åä„ÅØ„Çà„ÅÜ„ÄÇ‰ªäÊúù„ÅØÁ©∫Ê∞ó„ÅåÊæÑ„Çì„Åß„ÅÑ„Å¶Ê∞óÊåÅ„Å°„Åå„ÅÑ„ÅÑ„ÄÇ\n‰ªäÊó•„ÅØÊñ∞„Åó„ÅÑÊ©üËÉΩ„ÅÆÂÆüË£Ö„Å´Âèñ„ÇäÊéõ„Åã„Çã‰∫àÂÆö„ÄÇ",
          categories: [
            { name: "Êó•Â∏∏", color: "#bf8a8a" },
            { name: "ÈñãÁô∫„É≠„Ç∞", color: "#669bbc" },
          ],
          timestamp: isoDate(createDate(0, 8, 45)),
          dateStr: fmtDate(createDate(0, 8, 45)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(1, 23, 10).getTime(),
          content:
            "Ê∑±Â§ú„ÅÆ„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„ÅØ‰∏çÊÄùË≠∞„Å®Êçó„Çã„ÄÇBGM„ÅØÈõ®„ÅÆÈü≥„ÄÇ\n„Äå„Å≤„Å®„Çä„Åº„Åó„Äç„ÅÆ„Ç≥„É≥„Çª„Éó„Éà„Å´„Å§„ÅÑ„Å¶Ê∑±„ÅèËÄÉ„Åà„Å¶„ÅÑ„Åü„ÄÇ",
          categories: [
            { name: "Â§ú", color: "#8187dc" },
            { name: "ÈñãÁô∫„É≠„Ç∞", color: "#669bbc" },
          ],
          timestamp: isoDate(createDate(1, 23, 10)),
          dateStr: fmtDate(createDate(1, 23, 10)),
          comments: [
            {
              id: 101,
              content: "ÁÑ°ÁêÜ„Åó„Åô„Åé„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÇ",
              dateStr: fmtDate(createDate(0, 7, 0)),
            },
          ],
          quote: null,
        },
        {
          id: createDate(1, 15, 0).getTime(),
          content:
            "Êñ∞„Åó„ÅÑ„É©„Ç§„Éñ„É©„É™„ÇíË©¶„Åó„Å¶„Åø„Åü„Åë„Çå„Å©„ÄÅÊÄù„Å£„Åü„Çà„Çä‰æùÂ≠òÈñ¢‰øÇ„ÅåË§áÈõë„Å†„Å£„Åü„ÄÇ\n‰∏ÄÊó¶‰øùÁïô„Å´„Åó„Å¶„ÄÅÂà•„ÅÆÊñπÊ≥ï„ÇíÊé¢„Çã„ÄÇ",
          categories: [{ name: "ÈñãÁô∫„É≠„Ç∞", color: "#669bbc" }],
          timestamp: isoDate(createDate(1, 15, 0)),
          dateStr: fmtDate(createDate(1, 15, 0)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(1, 9, 30).getTime(),
          content:
            "„Åµ„Å®ÊÄù„ÅÑ„Å§„ÅÑ„Åü„Ç¢„Ç§„Éá„Ç¢„ÄÇ\nÊäïÁ®ø„Å´„ÄåÊòü„ÅÆÊòé„Çã„Åï„Äç„Åø„Åü„ÅÑ„Å™„Éë„É©„É°„Éº„Çø„ÇíÊåÅ„Åü„Åõ„Å¶„ÄÅÊÑüÊÉÖ„ÅÆÂº∑„Åï„ÇíË°®Áèæ„Åß„Åç„Å™„ÅÑ„Åã„Å™Ôºü",
          categories: [{ name: "„Ç¢„Ç§„Éá„Ç¢", color: "#d4a373" }],
          timestamp: isoDate(createDate(1, 9, 30)),
          dateStr: fmtDate(createDate(1, 9, 30)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(2, 21, 45).getTime(),
          content:
            "ÂØù„ÇãÂâç„Å´Â•Ω„Åç„Å™Èü≥Ê•Ω„ÇíËÅ¥„ÅèÊôÇÈñì„ÄÇ\n‰ªäÊó•‰∏ÄÊó•„ÅÇ„Å£„Åü„Åì„Å®„ÇíÊï¥ÁêÜ„Åó„Å¶„ÄÅÊòéÊó•„Å´ÂÇô„Åà„Çã„ÄÇ",
          categories: [
            { name: "Èü≥Ê•Ω", color: "#c08497" },
            { name: "Â§ú", color: "#8187dc" },
          ],
          timestamp: isoDate(createDate(2, 21, 45)),
          dateStr: fmtDate(createDate(2, 21, 45)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(2, 13, 0).getTime(),
          content: "Êï£Ê≠©‰∏≠„Å´Ë¶ã„Åã„Åë„ÅüÁå´„ÄÅ‰∫∫Êáê„Å£„Åì„Åè„Å¶ÂèØÊÑõ„Åã„Å£„Åü„ÄÇ",
          categories: [{ name: "Êó•Â∏∏", color: "#bf8a8a" }],
          timestamp: isoDate(createDate(2, 13, 0)),
          dateStr: fmtDate(createDate(2, 13, 0)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(3, 18, 20).getTime(),
          content:
            "UI„ÅÆÈÖçËâ≤Ë™øÊï¥„ÄÇ\nÊñáÂ≠ó„ÅÆËâ≤„ÇíÂ∞ë„ÅóËêΩ„Å®„Åó„Å¶„ÄÅÁõÆ„Å´ÂÑ™„Åó„Åè„Åó„Å¶„Åø„Åü„ÄÇ",
          categories: [{ name: "ÈñãÁô∫„É≠„Ç∞", color: "#669bbc" }],
          timestamp: isoDate(createDate(3, 18, 20)),
          dateStr: fmtDate(createDate(3, 18, 20)),
          comments: [],
          quote: {
            id: 999,
            content:
              "UI„ÅÆÈÖçËâ≤„ÄÅ„ÇÇ„ÅÜÂ∞ë„ÅóÂΩ©Â∫¶„Çí‰∏ã„Åí„Åü„Äå„Åè„Åô„Åø„Ç´„É©„Éº„Äç„Å´„Åó„ÅüÊñπ„Åå„ÄÅÂ§ú„Å´Ë¶ã„ÇãÊôÇ„Å´ÂøÉÂú∞„Çà„ÅÑ„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÄÇ",
            dateStr: fmtDate(createDate(4, 22, 0)),
            categories: [{ name: "„Ç¢„Ç§„Éá„Ç¢", color: "#d4a373" }],
          },
        },
        {
          id: createDate(3, 8, 15).getTime(),
          content:
            "ÈÄ±„ÅÆÁúü„Çì‰∏≠„ÄÇÂ∞ë„ÅóÁñ≤„Çå„ÅåÊ∫ú„Åæ„Å£„Å¶„Åç„Åü„Åã„ÇÇ„ÄÇ\n‰ªäÊó•„ÅØÊó©„ÇÅ„Å´Âàá„Çä‰∏ä„Åí„Å¶Êò†Áîª„Åß„ÇÇË¶≥„Çà„ÅÜ„ÄÇ",
          categories: [{ name: "Êó•Â∏∏", color: "#bf8a8a" }],
          timestamp: isoDate(createDate(3, 8, 15)),
          dateStr: fmtDate(createDate(3, 8, 15)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(4, 22, 0).getTime(),
          content:
            "UI„ÅÆÈÖçËâ≤„ÄÅ„ÇÇ„ÅÜÂ∞ë„ÅóÂΩ©Â∫¶„Çí‰∏ã„Åí„Åü„Äå„Åè„Åô„Åø„Ç´„É©„Éº„Äç„Å´„Åó„ÅüÊñπ„Åå„ÄÅÂ§ú„Å´Ë¶ã„ÇãÊôÇ„Å´ÂøÉÂú∞„Çà„ÅÑ„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÄÇ",
          categories: [{ name: "„Ç¢„Ç§„Éá„Ç¢", color: "#d4a373" }],
          timestamp: isoDate(createDate(4, 22, 0)),
          dateStr: fmtDate(createDate(4, 22, 0)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(4, 12, 0).getTime(),
          content:
            "„É©„É≥„ÉÅ„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„Åß„ÅÆÊ∞ó„Å•„Åç„Çí„É°„É¢„ÄÇ\n„Éª„Ç∑„É≥„Éó„É´„Åï„ÅØÊ©üËÉΩ„ÅÆÂ∞ë„Å™„Åï„Åß„ÅØ„Å™„ÅÑ\n„Éª„É¶„Éº„Ç∂„Éº„ÅÆËø∑„ÅÑ„ÇíÊ∏õ„Çâ„Åô„Åì„Å®„ÅåÊúÄÂÑ™ÂÖà",
          categories: [{ name: "„Ç¢„Ç§„Éá„Ç¢", color: "#d4a373" }],
          timestamp: isoDate(createDate(4, 12, 0)),
          dateStr: fmtDate(createDate(4, 12, 0)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(5, 7, 30).getTime(),
          content: "Êó©Ëµ∑„ÅçÊàêÂäü„ÄÇË™∞„ÇÇ„ÅÑ„Å™„ÅÑË°ó„ÇíÊ≠©„Åè„ÅÆ„ÅØÊ∞óÂàÜ„ÅåËâØ„ÅÑ„ÄÇ",
          categories: [{ name: "Êó•Â∏∏", color: "#bf8a8a" }],
          timestamp: isoDate(createDate(5, 7, 30)),
          dateStr: fmtDate(createDate(5, 7, 30)),
          comments: [],
          quote: null,
        },
        {
          id: createDate(7, 10, 0).getTime(),
          content:
            "„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂßãÂãï„ÄÇ„Åæ„Åö„ÅØÊäÄË°ìÈÅ∏ÂÆö„Åã„Çâ„ÄÇ\n‰ªäÂõû„ÅØVue.js„Çí‰Ωø„Çè„Åö„ÄÅ„ÅÇ„Åà„Å¶Vanilla JS„Å†„Åë„Åß„Å©„Åì„Åæ„ÅßË°®Áèæ„Åß„Åç„Çã„ÅãÊåëÊà¶„Åó„Å¶„Åø„Çã„ÄÇ",
          categories: [{ name: "ÈñãÁô∫„É≠„Ç∞", color: "#669bbc" }],
          timestamp: isoDate(createDate(7, 10, 0)),
          dateStr: fmtDate(createDate(7, 10, 0)),
          comments: [],
          quote: null,
        },
      ];

      // Â§âÊï∞Áæ§
      let currentNote = "";
      let selectedCategories = [];
      let quotingNote = null;
      let newCategoryName = "";
      let newCategoryColor = "#bf8a8a";
      let searchTerm = "";
      let filterTags = [];
      let commentingNote = null;
      let commentText = "";
      let calendarSelectedDate = null;
      let activeView = "notes";
      let sidebarOpen = false;

      const COLOR_PALETTE = [
        "#bf8a8a",
        "#d4a373",
        "#a3b18a",
        "#588157",
        "#669bbc",
        "#8187dc",
        "#c08497",
        "#8d99ae",
      ];

      // =================================================================
      // 2. „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ & ‰øùÂ≠ò
      // =================================================================
      const STORAGE_KEY_NOTES = "hitoriboshi-demo-v3-notes";
      const STORAGE_KEY_CATS = "hitoriboshi-demo-v3-categories";

      const loadData = () => {
        try {
          const notesStr = localStorage.getItem(STORAGE_KEY_NOTES);
          const categoriesStr = localStorage.getItem(STORAGE_KEY_CATS);
          if (notesStr) notes = JSON.parse(notesStr);
          else saveData();
          if (categoriesStr) categories = JSON.parse(categoriesStr);
          renderApp();
        } catch (error) {
          console.error("„Éá„Éº„Çø„É≠„Éº„ÉâÂ§±Êïó:", error);
        }
      };

      const saveData = () => {
        try {
          localStorage.setItem(STORAGE_KEY_NOTES, JSON.stringify(notes));
          localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(categories));
        } catch (error) {
          console.error("„Éá„Éº„Çø‰øùÂ≠òÂ§±Êïó:", error);
        }
      };

      const renderApp = () => {
        const appRoot = document.getElementById("app");
        appRoot.innerHTML = createLayout();
        attachElementListeners();
        lucide.createIcons();
      };

      const getNoteCategories = (note) => note.categories || [];
      const escapeHtml = (text) => {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      };

      // =================================================================
      // 3. „É≠„Ç∏„ÉÉ„ÇØ
      // =================================================================
      // NoteÁ≥ª
      const addNote = () => {
        if (currentNote.trim()) {
          const newNote = {
            id: Date.now(),
            content: currentNote,
            categories: [...selectedCategories],
            timestamp: new Date().toISOString(),
            dateStr: new Date().toLocaleString("ja-JP"),
            comments: [],
            quote: quotingNote ? { ...quotingNote, quote: undefined } : null,
          };
          notes = [newNote, ...notes];
          saveData();
          currentNote = "";
          selectedCategories = [];
          quotingNote = null;
          activeView = "notes";
          renderApp();
        }
      };
      const deleteNote = (id) => {
        if (confirm("„Åì„ÅÆÊòüÔºàÊäïÁ®øÔºâ„ÇíÊ∂à„Åó„Åæ„Åô„ÅãÔºü")) {
          notes = notes.filter((n) => n.id !== id);
          saveData();
          renderApp();
        }
      };
      const startRetweet = (noteId) => {
        const n = notes.find((x) => x.id === noteId);
        if (n) {
          quotingNote = n;
          currentNote = "";
          selectedCategories = [];
          activeView = "create";
          renderApp();
        }
      };
      const cancelRetweet = () => {
        quotingNote = null;
        renderApp();
      };

      // CommentÁ≥ª
      const addComment = (noteId) => {
        if (commentText.trim()) {
          const nc = {
            id: Date.now(),
            content: commentText,
            timestamp: new Date().toISOString(),
            dateStr: new Date().toLocaleString("ja-JP"),
          };
          notes = notes.map((n) =>
            n.id === noteId
              ? { ...n, comments: [...(n.comments || []), nc] }
              : n
          );
          saveData();
          commentText = "";
          commentingNote = null;
          renderApp();
        }
      };
      const deleteComment = (nid, cid) => {
        notes = notes.map((n) =>
          n.id === nid
            ? { ...n, comments: n.comments.filter((c) => c.id !== cid) }
            : n
        );
        saveData();
        renderApp();
      };

      // CategoryÁ≥ª
      const addCategory = () => {
        const inp = document.getElementById("newCategoryNameInput");
        if (!inp) return;
        const name = inp.value.trim();
        if (name) {
          if (categories.some((c) => c.name === name)) {
            alert("ÂêåÂêç„ÅÆ„Çø„Ç∞„Åå„ÅÇ„Çä„Åæ„Åô");
            return;
          }
          const nc = { name, color: newCategoryColor };
          categories = [...categories, nc];
          selectedCategories = [...selectedCategories, nc];
          saveData();
          inp.value = "";
          newCategoryColor =
            COLOR_PALETTE[
              (COLOR_PALETTE.indexOf(newCategoryColor) + 1) %
                COLOR_PALETTE.length
            ];
          renderApp();
        }
      };
      const updateCategoryName = (old, nwn) => {
        if (!nwn || !nwn.trim() || nwn === old) {
          renderApp();
          return;
        }
        const trm = nwn.trim();
        if (categories.some((c) => c.name === trm)) {
          alert("„Åù„ÅÆÂêçÂâç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô");
          renderApp();
          return;
        }
        categories = categories.map((c) =>
          c.name === old ? { ...c, name: trm } : c
        );
        notes = notes.map((n) => ({
          ...n,
          categories: (n.categories || []).map((c) =>
            c.name === old ? { ...c, name: trm } : c
          ),
        }));
        selectedCategories = selectedCategories.map((c) =>
          c.name === old ? { ...c, name: trm } : c
        );
        filterTags = filterTags.map((t) => (t === old ? trm : t));
        saveData();
        renderApp();
      };
      const deleteCategory = (nm) => {
        if (confirm(`„Çø„Ç∞„Äå${nm}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
          categories = categories.filter((c) => c.name !== nm);
          notes = notes.map((n) => ({
            ...n,
            categories: (n.categories || []).filter((c) => c.name !== nm),
          }));
          selectedCategories = selectedCategories.filter((c) => c.name !== nm);
          filterTags = filterTags.filter((t) => t !== nm);
          saveData();
          renderApp();
        }
      };
      const toggleCategorySelection = (nm) => {
        const c = categories.find((x) => x.name === nm);
        if (!c) return;
        if (selectedCategories.some((x) => x.name === nm))
          selectedCategories = selectedCategories.filter((x) => x.name !== nm);
        else selectedCategories = [...selectedCategories, c];
        renderApp();
      };

      // Filter & Calendar
      const toggleFilterTag = (t) => {
        if (t === "NO_TAG")
          filterTags = filterTags.includes("NO_TAG")
            ? filterTags.filter((x) => x !== "NO_TAG")
            : [...filterTags, "NO_TAG"];
        else
          filterTags = filterTags.includes(t)
            ? filterTags.filter((x) => x !== t)
            : [...filterTags, t];
        renderApp();
      };
      const clearFilterTags = () => {
        filterTags = [];
        renderApp();
      };
      const getFilteredNotes = () => {
        let r = notes;
        if (filterTags.length > 0) {
          r = r.filter((n) => {
            const cs = getNoteCategories(n);
            if (filterTags.includes("NO_TAG") && cs.length === 0) return true;
            return cs.some((c) => filterTags.includes(c.name));
          });
        }
        if (searchTerm) {
          const lo = searchTerm.toLowerCase();
          r = r.filter(
            (n) =>
              n.content.toLowerCase().includes(lo) ||
              getNoteCategories(n).some((c) =>
                c.name.toLowerCase().includes(lo)
              )
          );
        }
        return r;
      };

      // =================================================================
      // 4. View ÁîüÊàê
      // =================================================================

      // =================================================================
      // 4. View ÁîüÊàê
      // =================================================================

      const createLayout = () => {
        const fNotes = getFilteredNotes();
        const mData = getMonthlyCalendarData();
        const mw = activeView === "calendar" ? "max-w-7xl" : "max-w-4xl";

        // ‚òÖ‰øÆÊ≠£„Éù„Ç§„É≥„Éà: „Éö„Éº„Ç∏„Å´„Çà„Å£„Å¶‰∏ä„ÅÆ‰ΩôÁôΩÔºàptÔºâ„ÇíÂ§â„Åà„Çã
        // "notes"ÔºàÊ§úÁ¥¢„Éê„Éº„Åå„ÅÇ„ÇãÁîªÈù¢Ôºâ„ÅÆÊôÇ„Å†„Åë pt-12 (Áã≠„Åè) „Å´„Åó„ÄÅ
        // „Åù„Çå‰ª•Â§ñ„ÅØ pt-24 (Â∫É„Åè/ÂÖÉ„ÅÆ„Åæ„Åæ) „Å´„Åô„Çã
        const paddingTop = activeView === "notes" ? "pt-6" : "pt-24";

        return `
          <div class="flex min-h-screen relative overflow-hidden">
             <div class="fixed inset-0 pointer-events-none z-0">
               ${Array(30)
                 .fill(0)
                 .map(
                   () =>
                     `<div class="star" style="left:${
                       Math.random() * 100
                     }%;top:${Math.random() * 100}%;width:${
                       Math.random() * 3 + 1
                     }px;height:${Math.random() * 3 + 1}px;animation-delay:${
                       Math.random() * 5
                     }s;opacity:${Math.random() * 0.5};"></div>`
                 )
                 .join("")}
             </div>
             <button id="mobileMenuBtn" class="md:hidden fixed top-4 left-4 z-50 text-slate-400 p-2 bg-slate-900/80 rounded border border-slate-700"><i data-lucide="menu"></i></button>

             <aside id="sidebar" class="fixed md:sticky top-0 left-0 h-screen w-[22rem] bg-slate-900/90 backdrop-blur-xl border-r border-slate-800/50 px-6 pb-6 pt-20 flex flex-col z-40 transition-transform duration-300 ${
               sidebarOpen
                 ? "translate-x-0"
                 : "-translate-x-full md:translate-x-0"
             }">
                <div class="mb-12 flex items-center gap-3 px-1">
                  <div class="relative group"><div class="absolute inset-0 bg-indigo-500/20 blur-xl rounded-full opacity-50 group-hover:opacity-100 transition duration-500"></div><span class="text-3xl relative z-10 drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]">ü™ê</span></div>
                  <div><h1 class="text-xl font-bold tracking-widest text-slate-100">„Å≤„Å®„Çä„Åº„Åó</h1><p class="text-slate-500 text-[10px] tracking-wider mt-0.5">Where your thoughts orbit</p></div>
                </div>
                <nav class="space-y-2 flex-1">
                  <button onclick="activeView='notes'; renderApp();" class="w-full text-left px-5 py-3 rounded-xl transition flex items-center gap-3 ${
                    activeView === "notes"
                      ? "bg-slate-800 text-indigo-300 shadow-lg shadow-black/20"
                      : "text-slate-400 hover:text-slate-200 hover:bg-slate-800/50"
                  }"><i data-lucide="sparkles" size="20"></i><span class="text-base font-medium">„Å§„Å∂„ÇÑ„Åç</span></button>
                  <button onclick="activeView='create'; renderApp();" class="w-full text-left px-5 py-3 rounded-xl transition flex items-center gap-3 ${
                    activeView === "create"
                      ? "bg-slate-800 text-indigo-300 shadow-lg shadow-black/20"
                      : "text-slate-400 hover:text-slate-200 hover:bg-slate-800/50"
                  }"><i data-lucide="pen-tool" size="20"></i><span class="text-base font-medium">„Å§„Å∂„ÇÑ„Åè</span></button>
                  <button onclick="activeView='calendar'; renderApp();" class="w-full text-left px-5 py-3 rounded-xl transition flex items-center gap-3 ${
                    activeView === "calendar"
                      ? "bg-slate-800 text-indigo-300 shadow-lg shadow-black/20"
                      : "text-slate-400 hover:text-slate-200 hover:bg-slate-800/50"
                  }"><i data-lucide="calendar" size="20"></i><span class="text-base font-medium">„Ç´„É¨„É≥„ÉÄ„Éº</span></button>
                </nav>
             </aside>
             <div id="overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden ${
               sidebarOpen ? "block" : "hidden"
             }"></div>

             <main class="flex-1 min-w-0 h-screen overflow-y-auto relative z-10 scroll-smooth">
               <div class="${mw} mx-auto px-4 md:px-8 ${paddingTop} pb-32">
                 ${activeView === "notes" ? createNotesView(fNotes) : ""}
                 ${activeView === "create" ? createCreateView() : ""}
                 ${activeView === "calendar" ? createCalendarView(mData) : ""}
               </div>
             </main>
          </div>
        `;
      };

      // Create View
      const createCreateView = () => {
        return `
          <div class="h-full flex flex-col mx-auto max-w-3xl">
            <h2 class="text-xl font-medium text-slate-200 mb-4 flex items-center gap-2"><i data-lucide="${
              quotingNote ? "message-square-quote" : "pen-line"
            }" class="text-indigo-400"></i></h2>
            
            <div class="bg-slate-900/30 border border-slate-800 rounded-xl p-4 shadow-xl backdrop-blur-sm mb-12 flex flex-col relative transition-colors focus-within:border-indigo-400/80">
              ${
                quotingNote
                  ? `<div class="mb-3 p-3 rounded-lg border border-dashed border-slate-700 bg-slate-950/50 relative group"><div class="absolute -top-2.5 left-3 bg-slate-900 px-1 text-[10px] text-indigo-400 flex items-center gap-1"><i data-lucide="quote" size="10"></i> ÂºïÁî®</div><button onclick="cancelRetweet()" class="absolute top-2 right-2 text-slate-600 hover:text-red-400 p-0.5 rounded-full hover:bg-slate-800 transition"><i data-lucide="x" size="12"></i></button><div class="text-sm text-slate-400 italic">"${escapeHtml(
                      quotingNote.content
                    )}"</div></div>`
                  : ""
              }
              <textarea id="currentNoteInput" placeholder="‰ªä„ÄÅÂøÉ„Å´„ÅÇ„ÇãË®ÄËëâ„Çí..." class="w-full bg-transparent border-none focus:ring-0 outline-none text-slate-200 placeholder-slate-600 resize-none text-lg leading-relaxed p-0 min-h-[160px] mb-4 text-left">${currentNote}</textarea>
              <div class="flex items-end justify-between pt-3 border-t border-slate-800/50">
                <div class="flex flex-wrap gap-1.5 max-w-[70%]">
                   ${
                     selectedCategories.length === 0
                       ? `<span class="text-xs text-slate-600 py-1"><i data-lucide="tag" size="12" class="inline mr-1"></i>„Çø„Ç∞Êú™ÈÅ∏Êäû</span>`
                       : selectedCategories
                           .map(
                             (cat) =>
                               `<button onclick="toggleCategorySelection('${cat.name}')" class="px-2 py-0.5 rounded text-[10px] bg-slate-800 border border-slate-700 text-slate-300 flex items-center gap-1 hover:bg-slate-700 hover:text-white hover:border-red-400/50 transition group" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Â§ñ„Åô"><span class="w-1.5 h-1.5 rounded-full" style="background-color: ${cat.color}"></span>${cat.name}<i data-lucide="x" size="10" class="opacity-0 group-hover:opacity-100 text-red-300"></i></button>`
                           )
                           .join("")
                   }
                </div>
                <button id="addNoteButton" ${
                  !currentNote.trim() ? "disabled" : ""
                } class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium transition shadow-lg shadow-indigo-900/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 text-base"><span>${
          quotingNote ? "ÂºïÁî®„Åó„Å¶Â±ä„Åë„Çã" : "Â±ä„Åë„Çã"
        }</span><i data-lucide="send" size="18"></i></button>
              </div>
            </div>

            <div class="space-y-2 px-1">
              <div class="flex items-center gap-3 mb-1">
                 <span class="text-lg text-slate-400 font-bold">„Çø„Ç∞„Éó„É¨„Éº„Éà</span>
              </div>
              <div class="flex items-center gap-2 mb-4">
                 <div class="flex gap-2 ml-3">
                    ${COLOR_PALETTE.map(
                      (color) =>
                        `<button onclick="newCategoryColor='${color}'; renderApp();" class="w-5 h-5 rounded-full transition hover:scale-110 ${
                          newCategoryColor === color
                            ? "ring-2 ring-white ring-offset-2 ring-offset-slate-950"
                            : "opacity-60 hover:opacity-100"
                        }" style="background-color: ${color}"></button>`
                    ).join("")}
                 </div>
                 <div class="flex items-center bg-slate-900 border border-slate-800 rounded px-2 py-0.5 focus-within:border-indigo-500/50 transition ml-2">
                   <input type="text" id="newCategoryNameInput" placeholder="„Çø„Ç∞„Çí‰ΩúÊàê..." class="bg-transparent border-none text-xs text-slate-300 w-24 focus:outline-none placeholder-slate-600"/>
                   <button id="addCategoryButton" class="text-slate-500 hover:text-indigo-400"><i data-lucide="plus" size="14"></i></button>
                 </div>
              </div>

              <div class="flex flex-wrap gap-2 max-h-[400px] overflow-y-auto pr-1">
                ${categories
                  .map((cat) => {
                    const isSelected = selectedCategories.some(
                      (c) => c.name === cat.name
                    );
                    return `
                    <div onclick="toggleCategorySelection('${cat.name}')" 
                         class="group inline-flex items-center rounded-full border transition-all overflow-hidden pl-3 pr-1 py-1 gap-1 cursor-pointer select-none
                         ${
                           isSelected
                             ? "bg-slate-800/80 border-indigo-500/50"
                             : "bg-slate-900/30 border-slate-700 hover:border-slate-500"
                         }">
                      
                      <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: ${
                        cat.color
                      }"></span>
                      
                      <input 
                        type="text" 
                        value="${cat.name}" 
                        onclick="event.stopPropagation()" 
                        onchange="updateCategoryName('${cat.name}', this.value)"
                        class="bg-transparent text-sm text-slate-300 focus:outline-none focus:text-white px-1 text-center placeholder-slate-600 transition"
                        style="field-sizing: content; min-width: 1.5rem;"
                        title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Á∑®ÈõÜ"
                      />

                      <button onclick="event.stopPropagation(); deleteCategory('${
                        cat.name
                      }')" 
                              class="w-5 h-5 flex items-center justify-center text-slate-500 hover:text-red-400 hover:bg-red-900/30 rounded-full transition" 
                              title="ÂâäÈô§">
                        <i data-lucide="x" class="w-3 h-3"></i>
                      </button>
                    </div>
                  `;
                  })
                  .join("")}
                ${
                  categories.length === 0
                    ? '<span class="text-xs text-slate-600">„Çø„Ç∞„Çí‰ΩúÊàê„Åô„Çã„Å®„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</span>'
                    : ""
                }
              </div>
            </div>
          </div>
        `;
      };

      // Notes View
      const createNotesView = (fNotes) => {
        return `
          <div class="space-y-12 max-w-3xl mx-auto">
            <button onclick="activeView='create'; renderApp();" 
              class="fixed bottom-8 right-6 md:right-10 w-14 h-14 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-[0_0_20px_rgba(79,70,229,0.4)] transition-all hover:scale-110 active:scale-95 z-50 flex items-center justify-center group"
              title="„Å§„Å∂„ÇÑ„Åè">
              <i data-lucide="pen-line" size="24"></i>
            </button>

            <div class="sticky top-0 z-20 bg-slate-950/80 backdrop-blur-md pt-8 pb-8 -my-4 border-b border-slate-800/50 mb-8">
              <div class="flex gap-4 mb-5 ml-12 md:ml-0"><div class="relative flex-1"><i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" size="16"></i><input type="text" placeholder="Ë®òÊÜ∂„ÇíÊé¢„Åô..." value="${searchTerm}" id="searchTermInput" class="w-full pl-12 pr-4 py-2 bg-slate-900 border border-slate-800 rounded-lg text-slate-300 text-sm focus:outline-none focus:border-indigo-500/50 transition placeholder-slate-600"/></div></div>
              <div class="flex flex-wrap gap-2 items-center"><i data-lucide="filter" class="text-slate-600 mr-2" size="16"></i><button onclick="toggleFilterTag('NO_TAG')" class="px-4 py-2 rounded-full text-sm transition border ${
                filterTags.includes("NO_TAG")
                  ? "bg-slate-700 text-white border-slate-600"
                  : "text-slate-500 border-slate-800 hover:bg-slate-900"
              }">„Çø„Ç∞„Å™„Åó</button>
                ${categories
                  .map(
                    (cat) =>
                      `<button onclick="toggleFilterTag('${
                        cat.name
                      }')" class="px-4 py-2 rounded-full text-sm transition border flex items-center gap-1" style="background-color:${
                        filterTags.includes(cat.name)
                          ? cat.color + "40"
                          : "transparent"
                      };color:${
                        filterTags.includes(cat.name) ? "#fff" : cat.color
                      };border-color:${
                        filterTags.includes(cat.name) ? cat.color : "#334155"
                      }">${cat.name}</button>`
                  )
                  .join("")}
                ${
                  filterTags.length > 0
                    ? `<button onclick="clearFilterTags()" class="text-xs text-slate-500 ml-2 hover:text-slate-300">„ÇØ„É™„Ç¢</button>`
                    : ""
                }
              </div>
            </div>
            <div class="space-y-12">
              ${
                fNotes.length === 0
                  ? `<div class="text-center py-24 opacity-30"><i data-lucide="wind" size="48" class="mb-4 mx-auto"></i><p>„Åì„Åì„Å´„ÅØÈùôÂØÇ„Åå„ÅÇ„Çä„Åæ„Åô</p></div>`
                  : fNotes
                      .map((n) => {
                        const mc = getNoteCategories(n)[0]?.color || "#475569";
                        return `<div class="group relative pl-3 pb-2 transition duration-500 hover:translate-x-1">
                   <div class="absolute left-0 top-1.5 bottom-0 w-0.5 rounded-full bg-slate-800 group-hover:bg-slate-700 transition-colors"></div>
                   <div class="absolute left-[-2px] top-2 w-1.5 h-1.5 rounded-full" style="background-color: ${mc}; box-shadow: 0 0 6px ${mc};"></div>
                   <div class="mb-1 flex items-baseline justify-between">
                     <div class="flex items-center flex-wrap gap-3"><span class="text-sm text-slate-500 font-mono tracking-wider">${
                       n.dateStr
                     }</span><div class="flex gap-1.5">${getNoteCategories(n)
                          .map(
                            (c) =>
                              `<span class="px-2 py-0.5 rounded-full text-[10px] border flex items-center" style="background-color:${c.color}20;color:${c.color};border-color:${c.color}60;">${c.name}</span>`
                          )
                          .join("")}</div></div>
                     <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300"><button onclick="startRetweet(${
                       n.id
                     })" class="text-slate-600 hover:text-indigo-400 transition"><i data-lucide="repeat-2" size="14"></i></button><button onclick="deleteNote(${
                          n.id
                        })" class="text-slate-600 hover:text-red-400 transition"><i data-lucide="trash-2" size="14"></i></button></div>
                   </div>
                   <div class="text-slate-200 leading-relaxed whitespace-pre-wrap text-base font-normal mt-2 mb-3 break-words text-left">${escapeHtml(
                     n.content
                   )}</div>
                   ${
                     n.quote
                       ? `<div class="mt-2 mb-4 p-2 rounded border border-slate-800 bg-slate-900/50 text-slate-400 text-xs"><div class="flex items-center gap-1 mb-0.5 text-xs text-slate-600 font-mono tracking-wider"><span>${
                           n.quote.dateStr
                         }</span></div><div class="pl-2 border-l-2 border-slate-700 text-[11px]">${escapeHtml(
                           n.quote.content
                         )}</div></div>`
                       : ""
                   }
                   <div class="mt-2 mb-2">${
                     commentingNote === n.id
                       ? `<div class="flex gap-2 animate-in fade-in duration-200"><input type="text" id="commentInput-${n.id}" data-note-id="${n.id}" value="${commentText}" class="comment-text-input flex-1 bg-transparent border-b border-indigo-500/50 text-xs text-slate-300 py-0.5 focus:outline-none placeholder-slate-600" placeholder="ËøΩË®ò..." autofocus /><button class="send-comment-btn text-indigo-400 hover:text-indigo-300" data-note-id="${n.id}"><i data-lucide="send" size="12"></i></button><button class="cancel-comment-btn text-slate-600 hover:text-slate-400"><i data-lucide="x" size="12"></i></button></div>`
                       : `<button data-note-id="${n.id}" class="toggle-comment-input flex items-center gap-1 text-[10px] text-slate-600 hover:text-slate-400 transition py-0.5"><i data-lucide="message-circle" size="10"></i><span>ËøΩË®ò...</span></button>`
                   }</div>
                   <div class="space-y-1 mb-1 ml-1 pl-2 border-l border-slate-800/50">${(
                     n.comments || []
                   )
                     .map(
                       (c) =>
                         `<div class="flex gap-2 items-start group/comment mt-2"><div class="mt-2 w-1 h-1 rounded-full bg-slate-700 flex-shrink-0"></div><div class="flex-1"><p class="text-xs text-slate-500 font-mono tracking-wider">${
                           c.dateStr
                         }</p><p class="text-[13px] text-slate-400 leading-snug break-words text-left">${escapeHtml(
                           c.content
                         )}</p></div><button onclick="deleteComment(${n.id}, ${
                           c.id
                         })" class="text-slate-700 hover:text-red-900 opacity-0 group-hover/comment:opacity-100 transition"><i data-lucide="x" size="10"></i></button></div>`
                     )
                     .join("")}</div>
                 </div>`;
                      })
                      .join("")
              }
            </div>
          </div>
         `;
      };

      // Calendar View
      const createCalendarView = (monthlyData) => {
        const getMonthlyCalendarData_internal = () => {
          if (notes.length === 0) return [];
          const monthSet = new Set();
          notes.forEach((n) => {
            const d = new Date(n.timestamp);
            monthSet.add(`${d.getFullYear()}-${d.getMonth()}`);
          });
          const sortedMonths = Array.from(monthSet)
            .map((ym) => {
              const [y, m] = ym.split("-").map(Number);
              return { year: y, month: m };
            })
            .sort((a, b) => b.year - a.year || b.month - a.month);
          return sortedMonths.map(({ year, month }) => {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const weeks = [];
            let currentWeek = Array(firstDayOfWeek).fill(null);
            for (let d = 1; d <= lastDay.getDate(); d++) {
              const dateStr = new Date(year, month, d)
                .toISOString()
                .split("T")[0];
              const dayNotes = notes.filter(
                (n) =>
                  new Date(n.timestamp).toISOString().split("T")[0] === dateStr
              );
              const dColors = [];
              const cSet = new Set();
              dayNotes.forEach((n) =>
                getNoteCategories(n).forEach((c) => {
                  if (!cSet.has(c.color)) {
                    cSet.add(c.color);
                    dColors.push(c.color);
                  }
                })
              );
              currentWeek.push({
                dateStr,
                day: d,
                noteCount: dayNotes.length,
                colors: dColors,
              });
              if (currentWeek.length === 7) {
                weeks.push(currentWeek);
                currentWeek = [];
              }
            }
            if (currentWeek.length > 0) {
              while (currentWeek.length < 7) currentWeek.push(null);
              weeks.push(currentWeek);
            }
            return {
              year,
              month: month + 1,
              monthName: `${year}Âπ¥${month + 1}Êúà`,
              weeks,
            };
          });
        };

        if (monthlyData.length === 0)
          return `<div class="flex flex-col items-center justify-center h-[60vh] text-slate-600"><i data-lucide="calendar-off" size="48" class="mb-4 opacity-50"></i><p>„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>`;

        let sNotes = [];
        let sDateStr = "";
        if (calendarSelectedDate) {
          sNotes = notes.filter(
            (n) =>
              new Date(n.timestamp).toISOString().split("T")[0] ===
              calendarSelectedDate
          );
          const d = new Date(calendarSelectedDate);
          sDateStr = `${d.getFullYear()}Âπ¥${
            d.getMonth() + 1
          }Êúà${d.getDate()}Êó•`;
        }

        const calHtml = monthlyData
          .map(
            (md) => `
           <div class="mb-10">
             <h3 class="text-xl font-bold text-slate-400 mb-4 pl-1 border-l-4 border-indigo-900/50">${
               md.monthName
             }</h3>
             <div class="grid grid-cols-7 gap-2 mb-2 text-center text-sm text-slate-600 font-medium"><span class="text-red-900/70">Êó•</span><span>Êúà</span><span>ÁÅ´</span><span>Ê∞¥</span><span>Êú®</span><span>Èáë</span><span class="text-indigo-900/70">Âúü</span></div>
             <div class="grid grid-cols-7 gap-2">
               ${md.weeks
                 .map((wk) =>
                   wk
                     .map((dy) => {
                       if (!dy) return `<div class="aspect-square"></div>`;
                       const isSel = calendarSelectedDate === dy.dateStr;
                       const hasN = dy.noteCount > 0;
                       return `<div onclick="calendarSelectedDate='${
                         dy.dateStr
                       }'; renderApp();" class="aspect-square rounded-xl border flex flex-col items-center justify-center cursor-pointer transition relative group ${
                         isSel
                           ? "bg-indigo-900/20 border-indigo-500/50 text-white shadow-[0_0_15px_rgba(99,102,241,0.2)]"
                           : "bg-slate-900/30 border-slate-800/50 text-slate-400 hover:bg-slate-800 hover:border-slate-700"
                       }"><span class="text-sm ${
                         hasN ? "font-bold text-slate-300" : ""
                       }">${dy.day}</span>${
                         hasN
                           ? `<div class="flex justify-center gap-0.5 mt-1 flex-wrap px-1">${dy.colors
                               .slice(0, 3)
                               .map(
                                 (c) =>
                                   `<div class="w-1.5 h-1.5 rounded-full" style="background-color:${c}"></div>`
                               )
                               .join("")}${
                               dy.colors.length === 0
                                 ? `<div class="w-1.5 h-1.5 rounded-full bg-slate-600"></div>`
                                 : ""
                             }</div>`
                           : ""
                       }</div>`;
                     })
                     .join("")
                 )
                 .join("")}
             </div>
           </div>
         `
          )
          .join("");

        const detHtml = `<div class="sticky top-0 h-full overflow-y-auto pl-1 pr-2">
           ${
             calendarSelectedDate
               ? `<div class="animate-in slide-in-from-right-4 fade-in duration-300"><div class="flex items-center justify-between mb-6 border-b border-slate-800 pb-4"><h2 class="text-2xl font-bold text-slate-200">${sDateStr}</h2><span class="text-sm text-slate-500">${
                   sNotes.length
                 } ‰ª∂„ÅÆË®òÈå≤</span></div><div class="space-y-6">${
                   sNotes.length > 0
                     ? sNotes
                         .map(
                           (n) =>
                             `<div class="relative pl-5 border-l-2 border-slate-800"><div class="absolute -left-[7px] top-1.5 w-3 h-3 rounded-full border-2 border-slate-950" style="background-color:${
                               getNoteCategories(n)[0]?.color || "#64748b"
                             }"></div><div class="text-xs text-slate-500 mb-1">${new Date(
                               n.timestamp
                             ).toLocaleTimeString("ja-JP", {
                               hour: "2-digit",
                               minute: "2-digit",
                             })}</div><div class="text-slate-300 whitespace-pre-wrap text-lg mb-2 break-words text-left">${escapeHtml(
                               n.content
                             )}</div>${
                               n.quote
                                 ? `<div class="bg-slate-900/50 border border-slate-800 p-2 rounded text-xs text-slate-500 mb-2">${escapeHtml(
                                     n.quote.content
                                   )}</div>`
                                 : ""
                             }<div class="flex gap-1 flex-wrap">${getNoteCategories(
                               n
                             )
                               .map(
                                 (c) =>
                                   `<span class="text-[10px] px-2 py-0.5 bg-slate-800 text-slate-400 rounded">${c.name}</span>`
                               )
                               .join("")}</div></div>`
                         )
                         .join("")
                     : `<div class="text-slate-600 text-base">Ë®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>`
                 }</div></div>`
               : `<div class="flex flex-col items-center justify-center h-64 text-slate-600 opacity-50"><i data-lucide="mouse-pointer-click" size="48" class="mb-4"></i><p class="text-lg">Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶Ë®òÈå≤„ÇíË°®Á§∫</p></div>`
           }
         </div>`;
        return `<div class="grid grid-cols-1 lg:grid-cols-[1.2fr_1fr] gap-12 h-full items-start"><div>${calHtml}</div><div class="bg-slate-900/20 rounded-2xl p-8 border border-slate-800/50 min-h-[600px]">${detHtml}</div></div>`;
      };

      const getMonthlyCalendarData = () => {
        if (notes.length === 0) return [];
        const monthSet = new Set();
        notes.forEach((n) => {
          const d = new Date(n.timestamp);
          monthSet.add(`${d.getFullYear()}-${d.getMonth()}`);
        });
        const sortedMonths = Array.from(monthSet)
          .map((ym) => {
            const [y, m] = ym.split("-").map(Number);
            return { year: y, month: m };
          })
          .sort((a, b) => b.year - a.year || b.month - a.month);
        return sortedMonths.map(({ year, month }) => {
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const firstDayOfWeek = firstDay.getDay();
          const weeks = [];
          let currentWeek = Array(firstDayOfWeek).fill(null);
          for (let d = 1; d <= lastDay.getDate(); d++) {
            const dateStr = new Date(year, month, d)
              .toISOString()
              .split("T")[0];
            const dayNotes = notes.filter(
              (n) =>
                new Date(n.timestamp).toISOString().split("T")[0] === dateStr
            );
            const dColors = [];
            const cSet = new Set();
            dayNotes.forEach((n) =>
              getNoteCategories(n).forEach((c) => {
                if (!cSet.has(c.color)) {
                  cSet.add(c.color);
                  dColors.push(c.color);
                }
              })
            );
            currentWeek.push({
              dateStr,
              day: d,
              noteCount: dayNotes.length,
              colors: dColors,
            });
            if (currentWeek.length === 7) {
              weeks.push(currentWeek);
              currentWeek = [];
            }
          }
          if (currentWeek.length > 0) {
            while (currentWeek.length < 7) currentWeek.push(null);
            weeks.push(currentWeek);
          }
          return {
            year,
            month: month + 1,
            monthName: `${year}Âπ¥${month + 1}Êúà`,
            weeks,
          };
        });
      };

      // 5. Events
      const attachElementListeners = () => {
        const mm = document.getElementById("mobileMenuBtn");
        const ov = document.getElementById("overlay");
        if (mm)
          mm.onclick = () => {
            sidebarOpen = !sidebarOpen;
            renderApp();
          };
        if (ov)
          ov.onclick = () => {
            sidebarOpen = false;
            renderApp();
          };
        const si = document.getElementById("searchTermInput");
        if (si) {
          si.oninput = (e) => {
            searchTerm = e.target.value;
            renderApp();
          };
          si.focus();
          si.setSelectionRange(si.value.length, si.value.length);
        }
        const ci = document.getElementById("currentNoteInput");
        if (ci)
          ci.oninput = (e) => {
            currentNote = e.target.value;
            const b = document.getElementById("addNoteButton");
            if (b) b.disabled = !currentNote.trim();
          };
        const ab = document.getElementById("addNoteButton");
        if (ab) ab.onclick = addNote;
        const acb = document.getElementById("addCategoryButton");
        if (acb) acb.onclick = addCategory;
        const nci = document.getElementById("newCategoryNameInput");
        if (nci)
          nci.onkeypress = (e) => {
            if (e.key === "Enter") addCategory();
          };
      };

      const setupGlobalListeners = () => {
        const r = document.getElementById("app");
        r.addEventListener("click", (e) => {
          const t = e.target.closest(".toggle-comment-input");
          if (t) {
            commentingNote = parseInt(t.dataset.noteId);
            commentText = "";
            renderApp();
          }
          const s = e.target.closest(".send-comment-btn");
          if (s) {
            const i = document.getElementById(
              `commentInput-${parseInt(s.dataset.noteId)}`
            );
            if (i) {
              commentText = i.value;
              addComment(parseInt(s.dataset.noteId));
            }
          }
          const c = e.target.closest(".cancel-comment-btn");
          if (c) {
            commentingNote = null;
            renderApp();
          }
        });
        r.addEventListener("keypress", (e) => {
          const i = e.target.closest(".comment-text-input");
          if (i && e.key === "Enter") {
            commentText = i.value;
            addComment(parseInt(i.dataset.noteId));
          }
        });
      };

      document.addEventListener("DOMContentLoaded", () => {
        setupGlobalListeners();
        loadData();
      });
    </script>
  </body>
</html>
