<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ê∞óÂàÜ„Éé„Éº„Éà üìù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      /* Lucide„Ç¢„Ç§„Ç≥„É≥„ÅÆÂàùÊúüÂåñÁî®„Çπ„Çø„Ç§„É´ */
      .lucide {
        display: inline-block;
      }
      /* „Ç´„É¨„É≥„ÉÄ„Éº„Çª„É´„ÅÆÁ∏¶Ê®™ÊØî„ÇíÊ≠£ÊñπÂΩ¢„Å´‰øù„Å§ */
      .aspect-square {
        aspect-ratio: 1 / 1;
      }
      /* „Éõ„Éê„ÉºÊôÇ„ÅÆË©≥Á¥∞„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÁî®„Çπ„Çø„Ç§„É´ */
      .group:hover .group-hover\:block {
        display: block;
      }
    </style>
  </head>
  <body>
    <div
      id="app"
      class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-4"
    ></div>

    <script>
      // =================================================================
      // 1. „Ç∞„É≠„Éº„Éê„É´„Å™StateÂ§âÊï∞
      // =================================================================
      let notes = [];
      let categories = [];
      let currentNote = "";
      let selectedCategory = null;
      let searchTerm = "";
      let activeView = "notes";
      let editingNote = null;
      let commentingNote = null;
      let commentText = "";

      // =================================================================
      // 2. „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
      // =================================================================

      // localStorage„Åã„Çâ„Éá„Éº„Çø„Çí„É≠„Éº„Éâ
      const loadData = () => {
        try {
          const notesStr = localStorage.getItem("mood-notes");
          const categoriesStr = localStorage.getItem("mood-categories");

          if (notesStr) notes = JSON.parse(notesStr);
          if (categoriesStr) categories = JSON.parse(categoriesStr);

          // „É≠„Éº„ÉâÂæå„Å´ÊèèÁîª
          renderApp();
        } catch (error) {
          console.error("„Éá„Éº„Çø„É≠„Éº„ÉâÂ§±Êïó:", error);
        }
      };

      // localStorage„Å´„Éá„Éº„Çø„Çí‰øùÂ≠ò
      const saveData = () => {
        try {
          localStorage.setItem("mood-notes", JSON.stringify(notes));
          localStorage.setItem("mood-categories", JSON.stringify(categories));
        } catch (error) {
          console.error("„Éá„Éº„Çø‰øùÂ≠òÂ§±Êïó:", error);
        }
      };

      // „É´„Éº„ÉàDOMË¶ÅÁ¥†„ÇíÁ©∫„Å´„Åó„ÄÅÊñ∞„Åó„ÅÑHTML„ÇíÊèèÁîª„Åô„Çã
      const renderApp = () => {
        const appRoot = document.getElementById("app");
        appRoot.innerHTML = createLayout();

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        attachEventListeners();

        // Lucide„Ç¢„Ç§„Ç≥„É≥„ÇíÁΩÆ„ÅçÊèõ„Åà„Çã
        lucide.createIcons();
      };

      // =================================================================
      // 3. „Éá„Éº„ÇøÊìç‰Ωú„É≠„Ç∏„ÉÉ„ÇØ
      // =================================================================

      const addNote = () => {
        if (currentNote.trim() && selectedCategory) {
          const newNote = {
            id: Date.now(),
            content: currentNote,
            category: selectedCategory,
            timestamp: new Date().toISOString(),
            dateStr: new Date().toLocaleString("ja-JP"),
            comments: [],
          };

          if (editingNote) {
            notes = notes.map((n) =>
              n.id === editingNote.id
                ? {
                    ...editingNote,
                    content: currentNote,
                    category: selectedCategory,
                  }
                : n
            );
          } else {
            notes = [newNote, ...notes];
          }

          saveData();

          // State„ÇØ„É™„Ç¢„Å®ÂÜçÊèèÁîª
          currentNote = "";
          selectedCategory = null;
          editingNote = null;
          renderApp();
        }
      };

      const deleteNote = (id) => {
        if (confirm("Êú¨ÂΩì„Å´„Åì„ÅÆ„Éé„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
          notes = notes.filter((n) => n.id !== id);
          saveData();
          renderApp();
        }
      };

      const editNote = (noteId) => {
        const noteToEdit = notes.find((n) => n.id === noteId);
        if (noteToEdit) {
          currentNote = noteToEdit.content;
          selectedCategory = noteToEdit.category;
          editingNote = noteToEdit;
          activeView = "notes";
          renderApp();
        }
      };

      const addComment = (noteId) => {
        if (commentText.trim()) {
          const newComment = {
            id: Date.now(),
            content: commentText,
            timestamp: new Date().toISOString(),
            dateStr: new Date().toLocaleString("ja-JP"),
          };

          notes = notes.map((note) => {
            if (note.id === noteId) {
              return {
                ...note,
                comments: [...(note.comments || []), newComment],
              };
            }
            return note;
          });

          saveData();
          commentText = "";
          commentingNote = null;
          renderApp();
        }
      };

      const deleteComment = (noteId, commentId) => {
        notes = notes.map((note) => {
          if (note.id === noteId) {
            return {
              ...note,
              comments: note.comments.filter((c) => c.id !== commentId),
            };
          }
          return note;
        });
        saveData();
        renderApp();
      };

      const addCategory = () => {
        const newCategoryName = document
          .getElementById("newCategoryNameInput")
          .value.trim();
        const newCategoryColor = document.getElementById(
          "newCategoryColorInput"
        ).value;

        if (newCategoryName) {
          const newCategory = {
            name: newCategoryName,
            color: newCategoryColor,
          };
          categories = [...categories, newCategory];
          saveData();

          // State„Å®ÂÖ•Âäõ„ÇØ„É™„Ç¢
          document.getElementById("newCategoryNameInput").value = "";
          // document.getElementById('newCategoryColorInput').value = '#FFB6C1'; // Ëâ≤„ÅØ„Åù„ÅÆ„Åæ„ÅæÊÆã„Åô„Åã„ÄÅÂàùÊúüÂÄ§„Å´Êàª„Åô„Åã„ÅØ„ÅäÂ•Ω„Åø„Åß
          renderApp();
        }
      };

      const deleteCategory = (categoryName) => {
        if (confirm(`Êú¨ÂΩì„Å´„Çø„Ç∞„Äå${categoryName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
          categories = categories.filter((c) => c.name !== categoryName);
          saveData();
          renderApp();
        }
      };

      // =================================================================
      // 4. „Éá„Éº„Çø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÉªÊï¥ÂΩ¢
      // =================================================================

      const getFilteredNotes = () => {
        if (!searchTerm) return notes;
        return notes.filter(
          (note) =>
            note.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
            note.category.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
      };

      const getGroupedNotes = () => {
        return categories
          .map((cat) => ({
            category: cat,
            notes: notes.filter((n) => n.category.name === cat.name),
          }))
          .filter((group) => group.notes.length > 0);
      };

      // „Ç´„É¨„É≥„ÉÄ„Éº„Éá„Éº„Çø„ÅÆÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ (ÂÖÉ„ÅÆ„Ç≥„Éº„Éâ„Åã„ÇâÁßªÊ§ç)
      const getMonthlyCalendarData = () => {
        if (notes.length === 0) return [];

        const monthSet = new Set();
        notes.forEach((note) => {
          const date = new Date(note.timestamp);
          const yearMonth = `${date.getFullYear()}-${date.getMonth()}`;
          monthSet.add(yearMonth);
        });

        const sortedMonths = Array.from(monthSet)
          .map((ym) => {
            const [year, month] = ym.split("-").map(Number);
            return { year, month };
          })
          .sort((a, b) => {
            if (a.year !== b.year) return b.year - a.year;
            return b.month - a.month;
          });

        const months = [];

        sortedMonths.forEach(({ year, month }) => {
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const firstDayOfWeek = firstDay.getDay();

          const weeks = [];
          let currentWeek = [];

          for (let i = 0; i < firstDayOfWeek; i++) {
            currentWeek.push(null);
          }

          for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month, day);
            const dateStr = date.toISOString().split("T")[0];

            const dayNotes = notes.filter((note) => {
              const noteDate = new Date(note.timestamp)
                .toISOString()
                .split("T")[0];
              return noteDate === dateStr;
            });

            const uniqueCategories = [];
            const categoryMap = new Map();
            dayNotes.forEach((note) => {
              if (!categoryMap.has(note.category.name)) {
                categoryMap.set(note.category.name, note.category);
                uniqueCategories.push(note.category);
              }
            });

            currentWeek.push({
              date: dateStr,
              day: day,
              notes: dayNotes,
              categories: uniqueCategories,
            });

            if (currentWeek.length === 7) {
              weeks.push(currentWeek);
              currentWeek = [];
            }
          }

          if (currentWeek.length > 0) {
            while (currentWeek.length < 7) {
              currentWeek.push(null);
            }
            weeks.push(currentWeek);
          }

          months.push({
            year,
            month: month + 1,
            monthName: `${year}Âπ¥${month + 1}Êúà`,
            weeks,
          });
        });

        return months;
      };

      // =================================================================
      // 5. HTMLÁîüÊàêÈñ¢Êï∞ („É¨„É≥„ÉÄ„É™„É≥„Ç∞)
      // =================================================================

      const createLayout = () => {
        const monthlyData = getMonthlyCalendarData();
        const filteredNotes = getFilteredNotes();
        const groupedNotes = getGroupedNotes();

        return `
                <div class="max-w-6xl mx-auto">
                    ${createHeader()}
                    ${
                      activeView === "notes"
                        ? createNotesView(filteredNotes)
                        : ""
                    }
                    ${
                      activeView === "categories"
                        ? createCategoriesView(groupedNotes)
                        : ""
                    }
                    ${
                      activeView === "calendar"
                        ? createCalendarView(monthlyData)
                        : ""
                    }
                    ${activeView === "manage" ? createManageView() : ""}
                </div>
            `;
      };

      const createHeader = () => {
        return `
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Ê∞óÂàÜ„Éé„Éº„Éà üìù</h1>
                    
                    <div class="flex gap-2 mb-4" id="nav-buttons">
                        <button data-view="notes" class="px-4 py-2 rounded-lg font-medium transition ${
                          activeView === "notes"
                            ? "bg-purple-500 text-white"
                            : "bg-gray-100 text-gray-600"
                        }">
                            üìù „Éé„Éº„Éà
                        </button>
                        <button data-view="categories" class="px-4 py-2 rounded-lg font-medium transition ${
                          activeView === "categories"
                            ? "bg-purple-500 text-white"
                            : "bg-gray-100 text-gray-600"
                        }">
                            üè∑Ô∏è „Ç´„ÉÜ„Ç¥„É™„Éº
                        </button>
                        <button data-view="calendar" class="px-4 py-2 rounded-lg font-medium transition ${
                          activeView === "calendar"
                            ? "bg-purple-500 text-white"
                            : "bg-gray-100 text-gray-600"
                        }">
                            üìÖ „Ç´„É¨„É≥„ÉÄ„Éº
                        </button>
                        <button data-view="manage" class="px-4 py-2 rounded-lg font-medium transition ${
                          activeView === "manage"
                            ? "bg-purple-500 text-white"
                            : "bg-gray-100 text-gray-600"
                        }">
                            ‚öôÔ∏è „Çø„Ç∞ÁÆ°ÁêÜ
                        </button>
                    </div>

                    <div class="relative">
                        <i data-lucide="search" class="lucide absolute left-3 top-3 text-gray-400" size="20"></i>
                        <input
                            type="text"
                            placeholder="„Éé„Éº„Éà„ÇÑ„Çø„Ç∞„ÇíÊ§úÁ¥¢..."
                            value="${searchTerm}"
                            id="searchTermInput"
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                    </div>
                </div>
            `;
      };

      const createNotesView = (filteredNotes) => {
        return `
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold mb-4">${
                          editingNote ? "„Éé„Éº„Éà„ÇíÁ∑®ÈõÜ" : "Êñ∞„Åó„ÅÑ„Éé„Éº„Éà"
                        }</h2>
                        
                        ${
                          categories.length === 0
                            ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <p class="text-yellow-800">„Åæ„Å†Ê∞óÂàÜ„Çø„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Äå„Çø„Ç∞ÁÆ°ÁêÜ„Äç„Åß„Çø„Ç∞„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                            </div>
                        `
                            : ""
                        }
                        
                        <textarea
                            id="currentNoteInput"
                            placeholder="Ê∞óÂàÜ„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ..."
                            class="w-full p-3 border border-gray-300 rounded-lg mb-4 min-h-32 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        >${currentNote}</textarea>
                        
                        ${
                          categories.length > 0
                            ? `
                            <div class="mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="tag" class="lucide text-gray-600" size="18"></i>
                                    <span class="font-medium text-gray-700">Ê∞óÂàÜ„ÇíÈÅ∏Êäû</span>
                                </div>
                                <div class="flex flex-wrap gap-2" id="category-selector">
                                    ${categories
                                      .map(
                                        (cat, idx) => `
                                        <button
                                            data-category-name="${cat.name}"
                                            class="px-4 py-2 rounded-full font-medium transition transform hover:scale-105 ${
                                              selectedCategory?.name ===
                                              cat.name
                                                ? "ring-2 ring-purple-500 ring-offset-2"
                                                : ""
                                            }"
                                            style="background-color: ${
                                              cat.color
                                            }; color: #fff;"
                                        >
                                            ${cat.name}
                                        </button>
                                    `
                                      )
                                      .join("")}
                                </div>
                            </div>
                        `
                            : ""
                        }

                        <button
                            id="addNoteButton"
                            data-action="${editingNote ? "update" : "add"}"
                            ${
                              !currentNote.trim() || !selectedCategory
                                ? "disabled"
                                : ""
                            }
                            class="w-full bg-purple-500 text-white py-3 rounded-lg font-medium hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition flex items-center justify-center gap-2"
                        >
                            <i data-lucide="plus-circle" class="lucide" size="20"></i>
                            ${editingNote ? "„Éé„Éº„Éà„ÇíÊõ¥Êñ∞" : "„Éé„Éº„Éà„Çí‰øùÂ≠ò"}
                        </button>
                        ${
                          editingNote
                            ? `
                            <button
                                id="cancelEditButton"
                                class="w-full mt-2 bg-gray-200 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-300 transition"
                            >
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                        `
                            : ""
                        }
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold mb-4">„Åô„Åπ„Å¶„ÅÆ„Éé„Éº„Éà (${
                          filteredNotes.length
                        })</h2>
                        <div class="space-y-3">
                            ${
                              filteredNotes.length === 0
                                ? `
                                <p class="text-gray-400 text-center py-8">„Åæ„Å†„Éé„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊ∞óÂàÜ„ÅÆË®òÈå≤„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                            `
                                : filteredNotes
                                    .map(
                                      (note) => `
                                <div
                                    class="border-l-4 p-4 rounded-lg shadow-sm hover:shadow-md transition"
                                    style="border-color: ${
                                      note.category.color
                                    }; background-color: ${
                                        note.category.color
                                      }10;"
                                >
                                    <div class="flex justify-between items-start mb-2">
                                        <span
                                            class="px-3 py-1 rounded-full text-sm font-medium text-white"
                                            style="background-color: ${
                                              note.category.color
                                            };"
                                        >
                                            ${note.category.name}
                                        </span>
                                        <div class="flex gap-2">
                                            <button
                                                data-note-id="${note.id}"
                                                class="edit-note-btn text-blue-500 hover:text-blue-700"
                                            >
                                                <i data-lucide="edit-2" class="lucide" size="16"></i>
                                            </button>
                                            <button
                                                data-note-id="${note.id}"
                                                class="delete-note-btn text-red-500 hover:text-red-700"
                                            >
                                                <i data-lucide="trash-2" class="lucide" size="16"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-gray-800 mb-2">${
                                      note.content
                                    }</p>
                                    <p class="text-sm text-gray-500 mb-3">${
                                      note.dateStr
                                    }</p>
                                    
                                    <div class="border-t pt-3 mt-3">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-sm font-medium text-gray-600">
                                                „Ç≥„É°„É≥„Éà (${
                                                  note.comments
                                                    ? note.comments.length
                                                    : 0
                                                })
                                            </span>
                                        </div>
                                        
                                        ${
                                          note.comments &&
                                          note.comments.length > 0
                                            ? `
                                            <div class="space-y-2 mb-3">
                                                ${note.comments
                                                  .map(
                                                    (comment) => `
                                                    <div class="bg-white p-2 rounded border">
                                                        <p class="text-sm text-gray-700">${comment.content}</p>
                                                        <div class="flex justify-between items-center mt-1">
                                                            <p class="text-xs text-gray-400">${comment.dateStr}</p>
                                                            <button
                                                                data-note-id="${note.id}"
                                                                data-comment-id="${comment.id}"
                                                                class="delete-comment-btn text-red-400 hover:text-red-600"
                                                            >
                                                                <i data-lucide="trash-2" class="lucide" size="12"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                `
                                                  )
                                                  .join("")}
                                            </div>
                                        `
                                            : ""
                                        }
                                        
                                        ${
                                          commentingNote === note.id
                                            ? `
                                            <div class="flex gap-2">
                                                <input
                                                    type="text"
                                                    id="commentInput-${note.id}"
                                                    data-note-id="${note.id}"
                                                    value="${commentText}"
                                                    placeholder="„Ç≥„É°„É≥„Éà„ÇíÊõ∏„Åè..."
                                                    class="comment-text-input flex-1 p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                />
                                                <button
                                                    data-note-id="${note.id}"
                                                    class="send-comment-btn bg-purple-500 text-white px-3 py-2 rounded-lg hover:bg-purple-600 transition"
                                                >
                                                    <i data-lucide="send" class="lucide" size="16"></i>
                                                </button>
                                                <button
                                                    data-note-id="${note.id}"
                                                    class="cancel-comment-btn bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300 transition"
                                                >
                                                    <i data-lucide="x" class="lucide" size="16"></i>
                                                </button>
                                            </div>
                                        `
                                            : `
                                            <button
                                                data-note-id="${note.id}"
                                                class="toggle-comment-input text-sm text-purple-500 hover:text-purple-700 font-medium"
                                            >
                                                + „Ç≥„É°„É≥„Éà„ÇíËøΩÂä†
                                            </button>
                                        `
                                        }
                                    </div>
                                </div>
                            `
                                    )
                                    .join("")
                            }
                        </div>
                    </div>
                </div>
            `;
      };

      const createCategoriesView = (groupedNotes) => {
        return `
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">Ê∞óÂàÜÂà•„Å´ÂàÜÈ°û</h2>
                    ${
                      groupedNotes.length === 0
                        ? `
                        <p class="text-gray-400 text-center py-8">„Åæ„Å†„Éé„Éº„Éà„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    `
                        : `
                        <div class="space-y-4">
                            ${groupedNotes
                              .map(
                                (group, idx) => `
                                <div class="border-l-4 rounded-lg p-4" style="border-color: ${
                                  group.category.color
                                }">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span
                                            class="px-3 py-1 rounded-full text-white font-medium"
                                            style="background-color: ${
                                              group.category.color
                                            }"
                                        >
                                            ${group.category.name}
                                        </span>
                                        <span class="text-gray-500">(${
                                          group.notes.length
                                        }‰ª∂)</span>
                                    </div>
                                    <div class="space-y-2">
                                        ${group.notes
                                          .map(
                                            (note) => `
                                            <div class="bg-gray-50 p-3 rounded-lg">
                                                <p class="text-gray-800 mb-1">${note.content}</p>
                                                <p class="text-xs text-gray-500">${note.dateStr}</p>
                                            </div>
                                        `
                                          )
                                          .join("")}
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    `
                    }
                </div>
            `;
      };

      const createCalendarView = (monthlyData) => {
        if (monthlyData.length === 0) {
          return `
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <p class="text-gray-400 text-center py-8">„Åæ„Å†„Éé„Éº„Éà„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    </div>
                `;
        }

        const calendarHtml = monthlyData
          .map(
            (monthData, monthIdx) => `
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">üìÖ ${
                      monthData.monthName
                    }</h2>
                    
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        ${["Êó•", "Êúà", "ÁÅ´", "Ê∞¥", "Êú®", "Èáë", "Âúü"]
                          .map(
                            (day) => `
                            <div class="text-center text-sm font-semibold text-gray-600 py-1">
                                ${day}
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                    
                    <div class="space-y-2">
                        ${monthData.weeks
                          .map(
                            (week) => `
                            <div class="grid grid-cols-7 gap-2">
                                ${week
                                  .map((day) => {
                                    if (!day)
                                      return `<div class="aspect-square"><div class="w-full h-full bg-transparent"></div></div>`;

                                    const categoriesCount =
                                      day.categories.length;
                                    let contentHtml = "";

                                    if (categoriesCount === 0) {
                                      contentHtml = `<div class="w-full h-full bg-gray-50"></div>`;
                                    } else if (categoriesCount === 1) {
                                      contentHtml = `<div class="w-full h-full" style="background-color: ${day.categories[0].color}"></div>`;
                                    } else if (categoriesCount === 2) {
                                      contentHtml = `
                                            <div class="w-full h-full flex">
                                                <div class="w-1/2 h-full" style="background-color: ${day.categories[0].color}"></div>
                                                <div class="w-1/2 h-full" style="background-color: ${day.categories[1].color}"></div>
                                            </div>
                                        `;
                                    } else if (categoriesCount === 3) {
                                      contentHtml = `
                                            <div class="w-full h-full flex flex-wrap">
                                                <div class="w-1/2 h-1/2" style="background-color: ${day.categories[0].color}"></div>
                                                <div class="w-1/2 h-1/2" style="background-color: ${day.categories[1].color}"></div>
                                                <div class="w-full h-1/2" style="background-color: ${day.categories[2].color}"></div>
                                            </div>
                                        `;
                                    } else {
                                      // 4„Å§‰ª•‰∏ä
                                      contentHtml = `
                                            <div class="w-full h-full flex flex-wrap">
                                                <div class="w-1/2 h-1/2" style="background-color: ${day.categories[0].color}"></div>
                                                <div class="w-1/2 h-1/2" style="background-color: ${day.categories[1].color}"></div>
                                                <div class="w-1/2 h-1/2" style="background-color: ${day.categories[2].color}"></div>
                                                <div class="w-1/2 h-1/2" style="background-color: ${day.categories[3].color}"></div>
                                            </div>
                                        `;
                                    }

                                    const tooltipText = `${monthData.month}/${
                                      day.day
                                    }${
                                      day.notes.length > 0
                                        ? ` - ${day.categories
                                            .map((c) => c.name)
                                            .join("„ÄÅ")} (${
                                            day.notes.length
                                          }‰ª∂)`
                                        : ""
                                    }`;

                                    return `
                                        <div class="aspect-square">
                                            <div
                                                class="w-full h-full rounded border-2 overflow-hidden transition-all hover:scale-105 cursor-pointer group relative"
                                                style="border-color: ${
                                                  categoriesCount > 0
                                                    ? day.categories[0].color
                                                    : "#e5e7eb"
                                                }"
                                            >
                                                <div class="absolute top-1 left-1 text-xs font-semibold text-gray-600 z-10">
                                                    ${day.day}
                                                </div>
                                                
                                                ${contentHtml}
                                                
                                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 whitespace-nowrap z-20">
                                                    ${tooltipText}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                  })
                                  .join("")}
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `
          )
          .join("");

        const legendHtml = `
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">„Ç´„É©„Éº„Çø„Ç∞</h3>
                    <div class="flex flex-wrap gap-2">
                        ${categories
                          .map(
                            (cat, idx) => `
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded" style="background-color: ${cat.color}"></div>
                                <span class="text-sm text-gray-600">${cat.name}</span>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;

        return `<div class="space-y-6">${calendarHtml}${legendHtml}</div>`;
      };

      const createManageView = () => {
        return `
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">Ê∞óÂàÜ„Çø„Ç∞„ÇíÁÆ°ÁêÜ</h2>
                    
                    <div class="border rounded-lg p-4 mb-6">
                        <h3 class="font-semibold mb-3">Êñ∞„Åó„ÅÑ„Çø„Ç∞„ÇíËøΩÂä†</h3>
                        <div class="flex gap-3">
                            <input
                                type="text"
                                placeholder="„Çø„Ç∞Âêç"
                                id="newCategoryNameInput"
                                class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            <input
                                type="color"
                                value="#FFB6C1"
                                id="newCategoryColorInput"
                                class="w-16 h-10 rounded cursor-pointer"
                            />
                            <button
                                id="addCategoryButton"
                                class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition"
                            >
                                ËøΩÂä†
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold mb-3">Êó¢Â≠ò„ÅÆ„Çø„Ç∞</h3>
                        ${
                          categories.length === 0
                            ? `
                            <p class="text-gray-400 text-center py-8">„Åæ„Å†„Çø„Ç∞„Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                        `
                            : `
                            <div class="space-y-2">
                                ${categories
                                  .map(
                                    (cat, idx) => `
                                    <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-8 h-8 rounded"
                                                style="background-color: ${
                                                  cat.color
                                                }"
                                            ></div>
                                            <span class="font-medium">${
                                              cat.name
                                            }</span>
                                            <span class="text-sm text-gray-500">
                                                (${
                                                  notes.filter(
                                                    (n) =>
                                                      n.category.name ===
                                                      cat.name
                                                  ).length
                                                }‰ª∂„ÅÆ„Éé„Éº„Éà)
                                            </span>
                                        </div>
                                        <button
                                            data-category-name="${cat.name}"
                                            class="delete-category-btn text-red-500 hover:text-red-700 p-2"
                                        >
                                            <i data-lucide="trash-2" class="lucide" size="18"></i>
                                        </button>
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        `
                        }
                    </div>
                </div>
            `;
      };

      // =================================================================
      // 6. „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
      // =================================================================

      const attachEventListeners = () => {
        const appRoot = document.getElementById("app");

        // --- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Å®Ê§úÁ¥¢ ---
        document
          .getElementById("nav-buttons")
          .addEventListener("click", (e) => {
            const button = e.target.closest("button");
            if (button) {
              activeView = button.dataset.view;
              renderApp();
            }
          });

        const searchInput = document.getElementById("searchTermInput");
        if (searchInput) {
          searchInput.addEventListener("input", (e) => {
            searchTerm = e.target.value;
            renderApp();
          });
        }

        // --- „Éé„Éº„Éà‰ΩúÊàê/Á∑®ÈõÜ ---
        const currentNoteInput = document.getElementById("currentNoteInput");
        if (currentNoteInput) {
          currentNoteInput.addEventListener("input", (e) => {
            currentNote = e.target.value;
            // ÂÖ•Âäõ‰∏≠„Å´„Éú„Çø„É≥„ÅÆdisabledÁä∂ÊÖã„ÇíÊõ¥Êñ∞„Åô„Çã„Åü„ÇÅ„Å´ÂÜçÊèèÁîª (React„ÅÆ„Çà„ÅÜ„Å™Ëá™ÂãïÊõ¥Êñ∞„Åå„Å™„ÅÑ„Åü„ÇÅ)
            renderApp();
          });
        }

        const categorySelector = document.getElementById("category-selector");
        if (categorySelector) {
          categorySelector.addEventListener("click", (e) => {
            const button = e.target.closest("button");
            if (button && button.dataset.categoryName) {
              const catName = button.dataset.categoryName;
              selectedCategory = categories.find((c) => c.name === catName);
              renderApp();
            }
          });
        }

        const addNoteBtn = document.getElementById("addNoteButton");
        if (addNoteBtn) {
          addNoteBtn.addEventListener("click", addNote);
        }

        const cancelEditBtn = document.getElementById("cancelEditButton");
        if (cancelEditBtn) {
          cancelEditBtn.addEventListener("click", () => {
            editingNote = null;
            currentNote = "";
            selectedCategory = null;
            renderApp();
          });
        }

        // --- „Éé„Éº„Éà„É™„Çπ„ÉàÊìç‰Ωú („Éá„É™„Ç≤„Éº„Éà) ---
        appRoot.addEventListener("click", (e) => {
          // Á∑®ÈõÜ„Éú„Çø„É≥
          const editBtn = e.target.closest(".edit-note-btn");
          if (editBtn) {
            const noteId = parseInt(editBtn.dataset.noteId);
            editNote(noteId);
          }

          // ÂâäÈô§„Éú„Çø„É≥
          const deleteBtn = e.target.closest(".delete-note-btn");
          if (deleteBtn) {
            const noteId = parseInt(deleteBtn.dataset.noteId);
            deleteNote(noteId);
          }

          // „Ç≥„É°„É≥„ÉàÂÖ•ÂäõË°®Á§∫„Éú„Çø„É≥
          const toggleCommentBtn = e.target.closest(".toggle-comment-input");
          if (toggleCommentBtn) {
            const noteId = parseInt(toggleCommentBtn.dataset.noteId);
            commentingNote = noteId;
            commentText = "";
            renderApp();
          }

          // „Ç≥„É°„É≥„ÉàÈÄÅ‰ø°„Éú„Çø„É≥
          const sendCommentBtn = e.target.closest(".send-comment-btn");
          if (sendCommentBtn) {
            const noteId = parseInt(sendCommentBtn.dataset.noteId);
            const input = document.getElementById(`commentInput-${noteId}`);
            commentText = input.value; // ÊúÄÊñ∞„ÅÆÂÖ•ÂäõÂÄ§„ÇíÂèçÊò†
            addComment(noteId);
          }

          // „Ç≥„É°„É≥„Éà„Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥
          const cancelCommentBtn = e.target.closest(".cancel-comment-btn");
          if (cancelCommentBtn) {
            commentingNote = null;
            commentText = "";
            renderApp();
          }

          // „Ç≥„É°„É≥„ÉàÂâäÈô§„Éú„Çø„É≥
          const deleteCommentBtn = e.target.closest(".delete-comment-btn");
          if (deleteCommentBtn) {
            const noteId = parseInt(deleteCommentBtn.dataset.noteId);
            const commentId = parseInt(deleteCommentBtn.dataset.commentId);
            deleteComment(noteId, commentId);
          }
        });

        // „Ç≥„É°„É≥„ÉàÂÖ•ÂäõÊôÇ„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
        appRoot.addEventListener("input", (e) => {
          const commentInput = e.target.closest(".comment-text-input");
          if (commentInput) {
            commentText = commentInput.value;
            // ÂÜçÊèèÁîª„ÅØ‰∏çË¶Å„ÄÇÈÄÅ‰ø°ÊôÇ„Å´State„ÇíÊõ¥Êñ∞„Åô„Çã„ÄÇ
          }
        });

        // „Ç≥„É°„É≥„ÉàÂÖ•Âäõ„Åß„ÅÆEnter„Ç≠„ÉºÂá¶ÁêÜ
        appRoot.addEventListener("keypress", (e) => {
          const commentInput = e.target.closest(".comment-text-input");
          if (commentInput && e.key === "Enter") {
            const noteId = parseInt(commentInput.dataset.noteId);
            commentText = commentInput.value;
            addComment(noteId);
          }
        });

        // --- „Çø„Ç∞ÁÆ°ÁêÜ ---
        const addCategoryBtn = document.getElementById("addCategoryButton");
        if (addCategoryBtn) {
          addCategoryBtn.addEventListener("click", addCategory);

          // Enter„Ç≠„Éº„Åß„Çø„Ç∞ËøΩÂä†
          const newCatInput = document.getElementById("newCategoryNameInput");
          if (newCatInput) {
            newCatInput.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                addCategory();
              }
            });
          }
        }

        appRoot.addEventListener("click", (e) => {
          const deleteCatBtn = e.target.closest(".delete-category-btn");
          if (deleteCatBtn) {
            const catName = deleteCatBtn.dataset.categoryName;
            deleteCategory(catName);
          }
        });
      };

      // =================================================================
      // 7. ÂàùÊúüÂåñ
      // =================================================================
      document.addEventListener("DOMContentLoaded", loadData);
    </script>
  </body>
</html>
